name: Send Daily Emails

on:
  schedule:
    - cron: '0 3 * * *'   # 11:00 China Standard Time

jobs:
  send:
    runs-on: ubuntu-latest
    env:
      RUNS_PER_DAY: '1'
      START_DATE: '2024-11-01'
      PYQ_OFFSET: '0'
      FITNESS_OFFSET: '0'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Compute rotation indices
        id: rotation
        run: |
          SLOT=0
          START_SECS=$(date -u -d "$START_DATE" +%s)
          NOW_SECS=$(date -u +%s)
          if [ "$NOW_SECS" -lt "$START_SECS" ]; then
            DAYS=0
          else
            DAYS=$(( (NOW_SECS - START_SECS) / 86400 ))
          fi
          BASE_INDEX=$(( DAYS * RUNS_PER_DAY + SLOT ))
          PYQ_INDEX=$(( BASE_INDEX + PYQ_OFFSET ))
          FITNESS_INDEX=$(( BASE_INDEX + FITNESS_OFFSET ))
          echo "PYQ_INDEX=$PYQ_INDEX" >> "$GITHUB_ENV"
          echo "FITNESS_INDEX=$FITNESS_INDEX" >> "$GITHUB_ENV"

      - name: Determine local send date
        id: today
        run: |
          TODAY=$(TZ=Asia/Shanghai date +%Y-%m-%d)
          echo "today=$TODAY" >> "$GITHUB_OUTPUT"

      - name: Check PyQ send history
        id: cache-pyq
        uses: actions/cache@v4
        with:
          path: .workflow-cache/pyq
          key: pyq-${{ steps.today.outputs.today }}

      - name: PyQ already sent today
        if: steps.cache-pyq.outputs.cache-hit == 'true'
        run: echo "PyQ email already sent for ${{ steps.today.outputs.today }}; skipping."

      - name: Send PyQ snippet
        if: steps.cache-pyq.outputs.cache-hit != 'true'
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          FROM_NAME: ${{ secrets.FROM_NAME }}
          SMTP_RECIPIENT: ${{ secrets.SMTP_RECIPIENT }}
        run: python send_pyq_snippet.py --index "$PYQ_INDEX"

      - name: Mark PyQ as sent
        if: steps.cache-pyq.outputs.cache-hit != 'true'
        run: |
          mkdir -p .workflow-cache/pyq
          echo "${{ steps.today.outputs.today }}" > .workflow-cache/pyq/last_sent

      - name: Check fitness send history
        id: cache-fitness
        uses: actions/cache@v4
        with:
          path: .workflow-cache/fitness
          key: fitness-${{ steps.today.outputs.today }}

      - name: Fitness already sent today
        if: steps.cache-fitness.outputs.cache-hit == 'true'
        run: echo "Fitness email already sent for ${{ steps.today.outputs.today }}; skipping."

      - name: Send fitness snippet
        if: steps.cache-fitness.outputs.cache-hit != 'true'
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          FROM_NAME: ${{ secrets.FROM_NAME }}
          SMTP_RECIPIENT: ${{ secrets.SMTP_RECIPIENT }}
        run: python send_fitness_snippet.py --index "$FITNESS_INDEX"

      - name: Mark fitness as sent
        if: steps.cache-fitness.outputs.cache-hit != 'true'
        run: |
          mkdir -p .workflow-cache/fitness
          echo "${{ steps.today.outputs.today }}" > .workflow-cache/fitness/last_sent
