name: Send Daily Emails

on:
  schedule:
    - cron: '0 3 * * *'   # 11:00 China Standard Time
    - cron: '25 11 * * *' # 19:25 CST
    - cron: '48 11 * * *' # 19:48 CST
    - cron: '20 14 * * *' # 22:20 CST (testing slot)
    - cron: '21 14 * * *' # 22:21 CST (testing slot)
  workflow_dispatch:
    inputs:
      run-slot:
        description: 'Manual run slot (0-4)'
        required: false
        default: '0'

jobs:
  send:
    runs-on: ubuntu-latest
    env:
      RUNS_PER_DAY: '5'
      START_DATE: '2024-11-01'
      PYQ_OFFSET: '0'
      FITNESS_OFFSET: '0'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Determine run slot
        id: slot
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            case "${{ github.event.schedule }}" in
              '0 3 * * *') SLOT=0 ;;
              '25 11 * * *') SLOT=1 ;;
              '48 11 * * *') SLOT=2 ;;
              '20 14 * * *') SLOT=3 ;;
              '21 14 * * *') SLOT=4 ;;
              *) echo "Unknown schedule: ${{ github.event.schedule }}"; exit 1 ;;
            esac
          else
            SLOT="${{ inputs.run-slot }}"
          fi
          echo "slot=${SLOT}" >> "$GITHUB_OUTPUT"

      - name: Compute rotation indices
        id: rotation
        run: |
          SLOT=${{ steps.slot.outputs.slot }}
          START_SECS=$(date -u -d "$START_DATE" +%s)
          NOW_SECS=$(date -u +%s)
          if [ "$NOW_SECS" -lt "$START_SECS" ]; then
            DAYS=0
          else
            DAYS=$(( (NOW_SECS - START_SECS) / 86400 ))
          fi
          BASE_INDEX=$(( DAYS * RUNS_PER_DAY + SLOT ))
          PYQ_INDEX=$(( BASE_INDEX + PYQ_OFFSET ))
          FITNESS_INDEX=$(( BASE_INDEX + FITNESS_OFFSET ))
          echo "PYQ_INDEX=$PYQ_INDEX" >> "$GITHUB_ENV"
          echo "FITNESS_INDEX=$FITNESS_INDEX" >> "$GITHUB_ENV"

      - name: Send PyQ snippet
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          FROM_NAME: ${{ secrets.FROM_NAME }}
          SMTP_RECIPIENT: ${{ secrets.SMTP_RECIPIENT }}
        run: python send_pyq_snippet.py --index "$PYQ_INDEX"

      - name: Send fitness snippet
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          FROM_NAME: ${{ secrets.FROM_NAME }}
          SMTP_RECIPIENT: ${{ secrets.SMTP_RECIPIENT }}
        run: python send_fitness_snippet.py --index "$FITNESS_INDEX"
