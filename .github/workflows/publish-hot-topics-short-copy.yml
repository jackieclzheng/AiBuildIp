name: Send Hot Topics Voiceover

on:
  schedule:
    - cron: "5 22 * * *" # 06:05 China Standard Time, daily
  workflow_dispatch:

permissions:
  contents: write

jobs:
  send-voiceover:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore voiceover state
        uses: actions/cache@v4
        with:
          path: .hot_topics_voiceover_state_hot-topics-voiceover
          key: hot-topics-voiceover-state-${{ github.run_id }}
          restore-keys: |
            hot-topics-voiceover-state-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Send voiceover email
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          FROM_NAME: ${{ secrets.FROM_NAME }}
          SMTP_RECIPIENT: ${{ secrets.SMTP_RECIPIENT }}
          SUBJECT_PREFIX: "AI 口播脚本"
          HOT_TOPICS_SOURCE: ai-paid-hot-topics/hot-topics-voiceover.md
          HOT_TOPICS_ITEMS_PER_RUN: 1
        run: python3 send_hot_topics_voiceover.py --count 1

      - name: Persist next voiceover index
        env:
          STATE_FILE: .hot_topics_voiceover_state_hot-topics-voiceover
        run: |
          if git status --porcelain "$STATE_FILE" | grep -q .; then
            git config user.email "actions@github.com"
            git config user.name "github-actions[bot]"
            git add "$STATE_FILE"
            git commit -m "chore: update voiceover state [skip ci]" || exit 0
            git push
          else
            echo "No state change to persist."
          fi
